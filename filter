import pandas as pd

class ExcelProcessor:
    def __init__(self, input_file, output_file):
        self.input_file = input_file
        self.output_file = output_file
        self.results_sheet_name = 'Results'
        self.scenarios_sheet_name = 'Scenarios'
        self.event_sheet_suffix = 'EVENT'

    def read_sheet(self, sheet_name):
        return pd.read_excel(self.input_file, sheet_name=sheet_name)

    def add_step_order(self, results_df):
        step_order = 1
        prev_test_case_ref = None
        results_df['Step Order'] = 0

        for index, row in results_df.iterrows():
            current_test_case_ref = row['Test Case Reference']
            current_step_description = row['Step Description']

            if current_test_case_ref != prev_test_case_ref or current_step_description != results_df.at[index - 1, 'Step Description']:
                step_order = 1

            results_df.at[index, 'Step Order'] = step_order
            step_order += 1
            prev_test_case_ref = current_test_case_ref

        return results_df

    def copy_data_to_event(self, results_df, event_df):
        event_df['Step Description'] = event_df['Output Reference'].map(results_df.set_index('Output Reference')['Step Description'])
        event_df['Step Order'] = event_df['Output Reference'].map(results_df.set_index('Output Reference')['Step Order'])
        event_df['Test Case Reference'] = event_df['Output Reference'].map(results_df.set_index('Output Reference')['Test Case Reference'])
        return event_df

    def process_results_sheet(self):
        results_df = self.read_sheet(self.results_sheet_name)
        results_df = self.add_step_order(results_df)
        results_df.to_excel(self.output_file, sheet_name=self.results_sheet_name, index=False)

    def process_event_sheets(self):
        for sheet_name in results_df.filter(regex=f'{self.event_sheet_suffix}$').columns:
            event_df = self.read_sheet(sheet_name)
            event_df = self.copy_data_to_event(results_df, event_df)
            event_df.to_excel(self.output_file, sheet_name=sheet_name, index=False)

    def process_excel(self):
        self.process_results_sheet()
        self.process_event_sheets()

# Example usage:
input_file = 'your_excel_file.xlsx'
output_file = 'your_output_file.xlsx'
processor = ExcelProcessor(input_file, output_file)
processor.process_excel()
